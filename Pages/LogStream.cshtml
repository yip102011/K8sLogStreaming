@page
@model K8sLogStreaming.Pages.LogStreamModel
@{
    ViewData["Title"] = $"K8S Logs - {Model.Namespace} - {Model.Resource} - {Model.MetaName}";
}

<div>
    <pre class="logs_container"></pre>
</div>

@section Scripts{
<style>
    main.pb-3 {
        padding-bottom: 0 !important;
    }

    body > .container {
        max-width: none;
    }

    .logs_container {
        /* 73px is total height of nav */
        height: calc(100vh - 73px);
        margin: 0px;
    }
</style>
<script asp-append-version="true" src="~/js/signalr/dist/browser/signalr.js"></script>
<script>
    (function () {
        "use strict";

        var hubUrl = "@SignalRChat.Hubs.LogStreamHub.HUB_URL";
        var k8sNamespace = "@Model.Namespace";

        var podNameListString = "@(string.Join(',',Model.PodNameList))";
        var podNameList = podNameListString.split(',');

        var connection = new signalR.HubConnectionBuilder().withUrl(hubUrl, { transport: signalR.HttpTransportType.WebSockets }).build();

        connection.start().then(function () {
            podNameList.forEach(podName => { registerForStreamNotifications(k8sNamespace, podName); });
        }).catch(function (err) {
            return console.error(err.toString());
        });

        function registerForStreamNotifications(k8sNamespace, podName) {
            var subscription = connection.stream("GetPodLog", k8sNamespace, podName).subscribe({
                next: (content) => {
                    var logContainer = $('.logs_container');
                    logContainer.append(content);

                    logContainer.scrollTop(logContainer[0].scrollHeight);
                }
            });
        }
    })();
</script>
}
